<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>รายงานค่าฝุ่น PM2.5</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body{
    font-family: 'Segoe UI', sans-serif;
    margin:0;
    padding:20px;
    text-align:center;
    transition: background 0.5s ease;
    color:#fff;
}
.container{
    max-width:800px;
    margin:auto;
    background: rgba(0,0,0,0.5);
    padding:20px;
    border-radius:15px;
}
h1{margin-bottom:10px;}
.pm-value{
    font-size:48px;
    font-weight:bold;
}
.normal{
    font-size:16px;
    margin-bottom:15px;
}
.advice{
    margin-top:15px;
    font-size:18px;
}
canvas{
    margin-top:20px;
}
@media(max-width:600px){
    .pm-value{font-size:36px;}
}
</style>
</head>
<body>

<div class="container">
    <h1>รายงานค่าฝุ่น PM2.5 (Real-time)</h1>
    <div id="location">กำลังตรวจสอบพิกัด...</div>
    <div class="pm-value" id="pmValue">--</div>
    <div class="normal">ค่าปกติไม่เกิน 37.5 µg/m³ (ค่าเฉลี่ย 24 ชม.)</div>
    <div class="advice" id="healthAdvice"></div>
    <canvas id="pmChart"></canvas>
</div>

<script>
const TOKEN = "28d1b5b3fd38de7d3c494d2580af5790b51bf4a3";

function getColor(pm){
    if(pm <= 37.5) return "#2ecc71";       // ดี
    if(pm <= 75) return "#f1c40f";         // ปานกลาง
    if(pm <= 150) return "#e67e22";        // เริ่มมีผลกระทบ
    return "#e74c3c";                      // อันตรายมาก
}

function getAdvice(pm){
    if(pm <= 37.5) 
        return "คุณภาพอากาศดี สามารถทำกิจกรรมกลางแจ้งได้ตามปกติ";
    if(pm <= 75) 
        return "กลุ่มเสี่ยงควรลดเวลาทำกิจกรรมกลางแจ้ง";
    if(pm <= 150) 
        return "ควรสวมหน้ากาก N95 และหลีกเลี่ยงกิจกรรมกลางแจ้ง";
    return "อันตรายมาก ควรอยู่ในอาคาร ปิดประตูหน้าต่าง และใช้เครื่องฟอกอากาศ";
}

function loadPM(lat, lon){
    fetch(`https://api.airvisual.com/v2/nearest_city?lat=${lat}&lon=${lon}&key=${TOKEN}`)
    .then(res=>res.json())
    .then(data=>{
        const pm = data.data.current.pollution.aqius;
        document.getElementById("pmValue").innerHTML = pm + " µg/m³";
        document.body.style.background = getColor(pm);
        document.getElementById("healthAdvice").innerHTML = getAdvice(pm);
        document.getElementById("location").innerHTML = 
            data.data.city + ", " + data.data.state;

        createChart(pm);
    })
    .catch(err=>{
        alert("ไม่สามารถดึงข้อมูลได้");
    });
}

function createChart(pm){
    new Chart(document.getElementById('pmChart'),{
        type:'bar',
        data:{
            labels:["น้อย (≤37.5)","ปานกลาง (≤75)","อันตรายมาก (>150)"],
            datasets:[{
                label:"ค่า PM2.5 ปัจจุบัน",
                data:[
                    pm<=37.5?pm:37.5,
                    pm>37.5 && pm<=75?pm:0,
                    pm>150?pm:0
                ],
                backgroundColor:[
                    "#2ecc71","#f1c40f","#e74c3c"
                ]
            }]
        },
        options:{
            responsive:true,
            plugins:{
                legend:{display:false}
            },
            scales:{
                y:{beginAtZero:true}
            }
        }
    });
}

if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(
        pos=>{
            loadPM(pos.coords.latitude,pos.coords.longitude);
        },
        ()=>{
            alert("กรุณาอนุญาตการเข้าถึงตำแหน่ง");
        }
    );
}else{
    alert("อุปกรณ์ไม่รองรับ Geolocation");
}
</script>

</body>
</html>
