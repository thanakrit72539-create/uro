<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PM2.5 Monitor Pro (Thailand Standard)</title>

<link rel="manifest" href="manifest.json">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">

<style>
body{
    font-family:'Prompt',sans-serif;
    margin:0;
    padding:0;
    text-align:center;
    transition:0.5s;
    color:white;
}
.container{
    padding:20px;
    max-width:900px;
    margin:auto;
}
.card{
    background:rgba(0,0,0,0.35);
    padding:20px;
    border-radius:20px;
    backdrop-filter:blur(15px);
    margin-bottom:20px;
}
.pm-value{
    font-size:60px;
    font-weight:600;
}
select,button{
    padding:8px 12px;
    border-radius:10px;
    border:none;
    margin:5px;
    cursor:pointer;
}
canvas{
    margin-top:20px;
}
h3{
    margin-top:40px;
}
</style>
</head>
<body>

<div class="container">

    <div class="card">
        <h2>üå´ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô PM2.5 ‡πÅ‡∏ö‡∏ö Real-Time</h2>
        <div id="location">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
        <div class="pm-value" id="pm25">--</div>
        <div id="status"></div>
        <div id="advice"></div>

        <div>
            <select id="province">
                <option value="">‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</option>
                <option value="bangkok">‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û</option>
                <option value="chiangmai">‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà</option>
                <option value="chonburi">‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ</option>
            </select>
            <button onclick="loadManual()">‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </div>

        <canvas id="aqiChart"></canvas>
    </div>

    <div class="card">
        <h3>üìä ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö PM2.5 ‡∏£‡∏≤‡∏¢‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</h3>
        <canvas id="compareChart"></canvas>
    </div>

</div>

<script>
const TOKEN="YOUR_WAQI_TOKEN"; // ‡πÉ‡∏™‡πà token ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
let chart;
let compareChart;

/* =========================
   ‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏™‡πâ‡∏ô Real-Time
========================= */
function initChart(){
    const ctx=document.getElementById('aqiChart');
    chart=new Chart(ctx,{
        type:'line',
        data:{
            labels:[],
            datasets:[{
                label:'PM2.5 (¬µg/m¬≥)',
                data:[],
                borderWidth:2,
                tension:0.3
            }]
        }
    });
}

function updateChart(value){
    const time=new Date().toLocaleTimeString();
    chart.data.labels.push(time);
    chart.data.datasets[0].data.push(value);
    if(chart.data.labels.length>10){
        chart.data.labels.shift();
        chart.data.datasets[0].data.shift();
    }
    chart.update();
}

/* =========================
   ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ó‡πà‡∏á‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö
========================= */
function initCompareChart(){
    const ctx=document.getElementById('compareChart');
    compareChart=new Chart(ctx,{
        type:'bar',
        data:{
            labels:['‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û','‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà','‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ'],
            datasets:[{
                label:'PM2.5 (¬µg/m¬≥)',
                data:[0,0,0],
                borderWidth:1
            }]
        }
    });
}

function updateCompareChart(values){
    compareChart.data.datasets[0].data=values;
    compareChart.update();
}

/* =========================
   ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
========================= */
function getLocation(){
    if(!navigator.geolocation){
        document.getElementById("location").innerText="‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS";
        return;
    }

    navigator.geolocation.getCurrentPosition(
        pos=>{
            const lat=pos.coords.latitude;
            const lon=pos.coords.longitude;
            fetchData(`geo:${lat};${lon}`);
        },
        err=>{
            document.getElementById("location").innerText="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á";
        }
    );
}

function loadManual(){
    const province=document.getElementById("province").value;
    if(province==="") getLocation();
    else fetchData(province);
}

function fetchData(endpoint){
    fetch(`https://api.waqi.info/feed/${endpoint}/?token=${TOKEN}`)
    .then(res=>res.json())
    .then(data=>{
        if(data.status==="ok"){
            const pm=data.data.iaqi?.pm25?.v;
            if(!pm){
                document.getElementById("location").innerText="‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• PM2.5";
                return;
            }
            document.getElementById("location").innerText=data.data.city.name;
            updateUI(pm);
        }else{
            document.getElementById("location").innerText="‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ";
        }
    })
    .catch(()=>{
        document.getElementById("location").innerText="‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠";
    });
}

/* =========================
   ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö
========================= */
function loadCompareData(){
    const provinces=['bangkok','chiangmai','chonburi'];
    const results=[];

    provinces.forEach((prov,index)=>{
        fetch(`https://api.waqi.info/feed/${prov}/?token=${TOKEN}`)
        .then(res=>res.json())
        .then(data=>{
            if(data.status==="ok"){
                const pm=data.data.iaqi?.pm25?.v||0;
                results[index]=pm;
                if(results.filter(v=>v!==undefined).length===3){
                    updateCompareChart(results);
                }
            }
        });
    });
}

/* =========================
   ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡πÑ‡∏ó‡∏¢ (PCD)
========================= */
function updateUI(pm){
    document.getElementById("pm25").innerText=pm+" ¬µg/m¬≥";

    let color,status,advice;

    if(pm<=15){
        color="#00bfff";
        status="‡∏î‡∏µ‡∏°‡∏≤‡∏Å";
        advice="‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏ö‡∏£‡∏¥‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡πå ‡∏ó‡∏≥‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏ó‡∏µ‡πà";
    }else if(pm<=25){
        color="#2ecc71";
        status="‡∏î‡∏µ";
        advice="‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏î‡∏µ";
    }else if(pm<=37){
        color="#f1c40f";
        status="‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á";
        advice="‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏ß‡∏£‡∏•‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á";
    }else if(pm<=50){
        color="#e67e22";
        status="‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏°‡∏µ‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö";
        advice="‡∏Ñ‡∏ß‡∏£‡∏™‡∏ß‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£";
        notify(pm,status);
    }else if(pm<=90){
        color="#e74c3c";
        status="‡∏°‡∏µ‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏ï‡πà‡∏≠‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û";
        advice="‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á";
        notify(pm,status);
    }else{
        color="#8e44ad";
        status="‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢";
        advice="‡∏Ñ‡∏ß‡∏£‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ ‡πÅ‡∏•‡∏∞‡∏™‡∏ß‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏Å N95";
        notify(pm,status);
    }

    document.body.style.background=color;
    document.getElementById("status").innerText=status;
    document.getElementById("advice").innerText=advice;
    updateChart(pm);
}

/* =========================
   Notification
========================= */
function notify(pm,status){
    if(Notification.permission==="granted"){
        new Notification("‚ö† PM2.5 ‡∏™‡∏π‡∏á!",{
            body:`${pm} ¬µg/m¬≥ ‡∏£‡∏∞‡∏î‡∏±‡∏ö ${status}`
        });
    }
}

if(Notification.permission!=="granted"){
    Notification.requestPermission();
}

/* =========================
   ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
========================= */
initChart();
initCompareChart();
getLocation();
loadCompareData();
setInterval(getLocation,300000);

if('serviceWorker' in navigator){
    navigator.serviceWorker.register('sw.js');
}
</script>

</body>
</html>
