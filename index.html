<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PM2.5 Monitor Pro</title>

<link rel="manifest" href="manifest.json">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">

<style>
body{
    font-family:'Prompt',sans-serif;
    margin:0;
    padding:0;
    text-align:center;
    transition:0.5s;
    color:white;
}
.container{
    padding:20px;
    max-width:700px;
    margin:auto;
}
.card{
    background:rgba(0,0,0,0.3);
    padding:20px;
    border-radius:20px;
    backdrop-filter:blur(15px);
}
.pm-value{
    font-size:60px;
    font-weight:600;
}
select,button{
    padding:8px 12px;
    border-radius:10px;
    border:none;
    margin:5px;
}
canvas{
    margin-top:20px;
}
</style>
</head>
<body>

<div class="container">
    <div class="card">
        <h2>üå´ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô PM2.5 ‡πÅ‡∏ö‡∏ö Real-Time</h2>
        <div id="location">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
        <div class="pm-value" id="pm25">--</div>
        <div id="status"></div>
        <div id="advice"></div>

        <div>
            <select id="province">
                <option value="">‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</option>
                <option value="bangkok">‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û</option>
                <option value="chiangmai">‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà</option>
                <option value="chonburi">‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ</option>
            </select>
            <button onclick="loadManual()">‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </div>

        <canvas id="aqiChart"></canvas>
    </div>
</div>

<script>
const TOKEN="28d1b5b3fd38de7d3c494d2580af5790b51bf4a3";
let chart;
let historyData=[];

function initChart(){
    const ctx=document.getElementById('aqiChart');
    chart=new Chart(ctx,{
        type:'line',
        data:{
            labels:[],
            datasets:[{
                label:'PM2.5',
                data:[],
                borderWidth:2
            }]
        }
    });
}

function updateChart(value){
    const time=new Date().toLocaleTimeString();
    chart.data.labels.push(time);
    chart.data.datasets[0].data.push(value);
    if(chart.data.labels.length>10){
        chart.data.labels.shift();
        chart.data.datasets[0].data.shift();
    }
    chart.update();
}

function getLocation(){
    navigator.geolocation.getCurrentPosition(pos=>{
        const lat=pos.coords.latitude;
        const lon=pos.coords.longitude;
        fetchData(`geo:${lat};${lon}`);
    });
}

function loadManual(){
    const province=document.getElementById("province").value;
    if(province==="") getLocation();
    else fetchData(province);
}

function fetchData(endpoint){
    fetch(`https://api.waqi.info/feed/${endpoint}/?token=${TOKEN}`)
    .then(res=>res.json())
    .then(data=>{
        if(data.status==="ok"){
            const pm=data.data.iaqi.pm25?.v || data.data.aqi;
            document.getElementById("location").innerText=data.data.city.name;
            updateUI(pm);
        }
    });
}

function updateUI(pm){
    document.getElementById("pm25").innerText=pm;
    let color,status,advice;

    if(pm<=25){
        color="#2ecc71"; status="‡∏î‡∏µ‡∏°‡∏≤‡∏Å";
        advice="‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏î‡∏µ ‡∏ó‡∏≥‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÑ‡∏î‡πâ";
    }else if(pm<=50){
        color="#27ae60"; status="‡∏î‡∏µ";
        advice="‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏î‡∏µ";
    }else if(pm<=100){
        color="#f1c40f"; status="‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á";
        advice="‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏ß‡∏£‡∏•‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á";
    }else if(pm<=150){
        color="#e67e22"; status="‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏°‡∏µ‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö";
        advice="‡∏Ñ‡∏ß‡∏£‡∏™‡∏ß‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏Å N95";
        notify(pm,status);
    }else{
        color="#e74c3c"; status="‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢";
        advice="‡∏Ñ‡∏ß‡∏£‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ ‡πÅ‡∏•‡∏∞‡∏™‡∏ß‡∏° N95";
        notify(pm,status);
    }

    document.body.style.background=color;
    document.getElementById("status").innerText=status;
    document.getElementById("advice").innerText=advice;
    updateChart(pm);
}

function notify(pm,status){
    if(Notification.permission==="granted"){
        new Notification("‚ö† PM2.5 ‡∏™‡∏π‡∏á!",{
            body:`${pm} ¬µg/m¬≥ ‡∏£‡∏∞‡∏î‡∏±‡∏ö ${status}`
        });
    }
}

if(Notification.permission!=="granted"){
    Notification.requestPermission();
}

initChart();
getLocation();
setInterval(getLocation,300000);

if('serviceWorker' in navigator){
    navigator.serviceWorker.register('sw.js');
}
</script>
</body>
</html>
