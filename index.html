<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PM2.5 Ultra Pro</title>

<link rel="manifest" href="manifest.json">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --bg: #1e1e1e;
  --card: #2c2c2c;
  --text: white;
}
@media (prefers-color-scheme: light){
  :root{
    --bg:#f4f4f4;
    --card:white;
    --text:#222;
  }
}

body{
  margin:0;
  font-family:Arial;
  background:var(--bg);
  color:var(--text);
  text-align:center;
}
.container{
  max-width:900px;
  margin:auto;
  padding:20px;
}
.card{
  background:var(--card);
  padding:20px;
  border-radius:20px;
  box-shadow:0 10px 30px rgba(0,0,0,0.2);
  margin-bottom:20px;
}
.pm{
  font-size:70px;
  font-weight:bold;
}
#map{
  width:100%;
  height:300px;
  border-radius:15px;
}
</style>
</head>
<body>

<div class="container">

<div class="card">
<h2>üå´ PM2.5 Real-Time</h2>
<div id="city">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
<div class="pm" id="pm">--</div>
<div id="status"></div>
<div id="advice"></div>
</div>

<div class="card">
<canvas id="chart"></canvas>
</div>

<div class="card">
<div id="map"></div>
</div>

</div>

<script>
const TOKEN="28d1b5b3fd38de7d3c494d2580af5790b51bf4a3";
let chart;

function initChart(){
  chart=new Chart(document.getElementById("chart"),{
    type:'line',
    data:{
      labels:[],
      datasets:[{
        label:"PM2.5 (24 ‡∏ä‡∏°.)",
        data:[],
        borderWidth:2
      }]
    },
    options:{
      responsive:true
    }
  });
}

function updateChart(arr){
  chart.data.labels = arr.map((_,i)=>i+"h");
  chart.data.datasets[0].data = arr;
  chart.update();
}

function updateUI(pm){
  document.getElementById("pm").innerText=pm;
  let status,advice,color;

  if(pm<=25){
    status="‡∏î‡∏µ‡∏°‡∏≤‡∏Å";
    advice="‡∏ó‡∏≥‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÑ‡∏î‡πâ";
    color="#2ecc71";
  }else if(pm<=50){
    status="‡∏î‡∏µ";
    advice="‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏î‡∏µ";
    color="#27ae60";
  }else if(pm<=100){
    status="‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á";
    advice="‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏ß‡∏£‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏´‡∏ô‡∏±‡∏Å";
    color="#f1c40f";
  }else if(pm<=150){
    status="‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏°‡∏µ‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö";
    advice="‡∏Ñ‡∏ß‡∏£‡∏™‡∏ß‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏Å N95";
    color="#e67e22";
    notify(pm);
  }else{
    status="‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢";
    advice="‡∏Ñ‡∏ß‡∏£‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£";
    color="#e74c3c";
    notify(pm);
  }

  document.body.style.background=color;
  document.getElementById("status").innerText=status;
  document.getElementById("advice").innerText=advice;
}

function notify(pm){
  if(Notification.permission==="granted"){
    new Notification("‚ö† PM2.5 ‡∏™‡∏π‡∏á!",{
      body:"‡∏Ñ‡πà‡∏≤‡∏ù‡∏∏‡πà‡∏ô "+pm+" ¬µg/m¬≥"
    });
  }
}

function loadData(lat,lon){
fetch(`https://api.waqi.info/feed/geo:${lat};${lon}/?token=${TOKEN}`)
.then(r=>r.json())
.then(d=>{
  if(d.status==="ok"){
    const pm=d.data.iaqi.pm25?.v || d.data.aqi;
    document.getElementById("city").innerText=d.data.city.name;
    updateUI(pm);

    // ‡∏î‡∏∂‡∏á‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á 24 ‡∏ä‡∏°.
    const history=d.data.forecast.daily.pm25.slice(0,24).map(x=>x.avg);
    updateChart(history);
  }
});
}

function initMap(lat,lon){
  const map=new google.maps.Map(document.getElementById("map"),{
    center:{lat, lng:lon},
    zoom:10
  });
  new google.maps.Marker({position:{lat,lng:lon},map:map});
}

navigator.geolocation.getCurrentPosition(pos=>{
  const lat=pos.coords.latitude;
  const lon=pos.coords.longitude;
  loadData(lat,lon);
  initMap(lat,lon);
});

if(Notification.permission!=="granted"){
  Notification.requestPermission();
}

initChart();

if("serviceWorker" in navigator){
  navigator.serviceWorker.register("sw.js");
}
</script>

<script async
src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY">
</script>

</body>
</html>
